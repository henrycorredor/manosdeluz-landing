---
import {parseHTML} from 'linkedom'

const html = await Astro.slots.render('tab-element')
const {document} = parseHTML(html)

document.children.map((child, index) => {
  if (index === 0) child.classList.add('active')
  child.classList.add('kl-tab-content')
})

interface Props {
  id: string
}

const {id, className} = Astro.props

const classNames = className ? `kl-tabs ${className}` : 'kl-tabs'
---

<div class=`${classNames}` id={id}>
  <div class="kl-tabs_nav">
    <slot name="nav-title"/>
    <div class="kl-tabs_nav_buttons">
      {document.children.map((DOMel, index) => {
        const {label} = DOMel.dataset
        return (
          <button class=`kl-tabs_nav_button${index === 0 ? " active" : ""}`
                  data-tab-set-id={id}
                  data-tab-index={index}>
            {label}
          </button>)
      })}
    </div>
  </div>
  <div class="kl-tabs_content">
    <Fragment set:html={document}/>
    <!--<slot name="tab-element"/>-->
  </div>
</div>

<style is:global lang="less">
  .kl-tabs {
    display: flex;
    gap: 1rem;

    &_nav {
      border-right: 1px solid black;
      padding-right: .5rem;

      &_buttons {
        display: flex;
        flex-direction: column;

        button {
          border: none;
          background: transparent;
          text-align: right;
          cursor: pointer;
          font-size: 1.2rem;
          padding: .5rem .1rem;

          &.active{
            border-right: 1px solid black;
            padding-right: calc(0.6rem - 1px);
            margin-right: -0.5rem;
          }
        }
      }
    }
    &_content{
      flex-grow: 1;
    }
  }

  .kl-tab-content:not(.active) {
    display: none;
  }
</style>

<script>
  function changeTab(id: string, index: string) {
    const content = document.querySelectorAll(`#${id} .kl-tabs_content > *`)
    const buttons = document.querySelectorAll(`#${id} .kl-tabs_nav_button`)
    content.forEach((el: HTMLDivElement) => {
      el.classList.remove("active")
    })
    content[index]?.classList.add("active")
    buttons.forEach((el: HTMLDivElement) => el.classList.remove("active"))
    buttons[index]?.classList.add("active")
  }

  document.querySelectorAll('.kl-tabs_nav_button').forEach((el: HTMLButtonElement) => {
    el.addEventListener("click", () => {
      const {tabIndex, tabSetId} = el.dataset;
      changeTab(tabSetId, tabIndex)
    })
  })
</script>