---
import {parseHTML} from 'linkedom'

const html = await Astro.slots.render('tab-element')
const {document} = parseHTML(html)

document.children.map((child, index) => {
  if (index === 0) child.classList.add('active')
  child.classList.add('kl-tab-content')
})

interface Props {
  id: string
}

const {id, className} = Astro.props

const classNames = className ? `kl-tabs ${className}` : 'kl-tabs'
---

<div class=`kl-tabs_container ${classNames}` id={id}>
  <div class="kl-tabs_nav">
    <slot name="nav-title"/>
    <div class="kl-tabs_nav_buttons">
      {document.children.map((DOMel, index) => {
        const {label} = DOMel.dataset
        return (
          <div class="kl-tabs_nav_buttons_button-container">
            <button class=`kl-tabs_nav_button${index === 0 ? " active" : ""}`
                    data-tab-set-id={id}
                    data-tab-index={index}>
              {label}
            </button>
            <div class="kl-tabs_nav_buttons_button-container_loader"></div>
          </div>
          )
      })}
    </div>
  </div>
  <div class="kl-tabs_content">
    <Fragment set:html={document}/>
    <!--<slot name="tab-element"/>-->
  </div>
</div>

<style is:global lang="less">
  .kl-tabs {
    display: flex;
    gap: 1rem;

    &_nav {
      border-right: 1px solid black;
      padding-right: .5rem;

      &_buttons {
        display: flex;
        flex-direction: column;

        &_button-container{
          text-align: right;
          &_loader{
            height: 1px;
            background: black;
            margin: 0 -0.5rem 0 auto;
            width: 0;
          }
        }

        button {
          border: none;
          background: transparent;
          text-align: right;
          cursor: pointer;
          font-size: 1.2rem;
          padding: .5rem .1rem;

          &.active{
            border-right: 1px solid black;
            padding-right: calc(0.6rem - 1px);
            margin-right: -0.5rem;
          }
        }
      }
    }
    &_content{
      flex-grow: 1;
    }
  }

  .kl-tab-content:not(.active) {
    display: none;
  }
</style>

<script>
  class KlTabController {
    private readonly delay: number

    private running: boolean
    private timeLeft: number
    private actualTabIndex: number
    public percentLeft: number

    private onTimeChangeCb: (percent: number) => void

    private container: HTMLDivElement
    private tabsButtons: NodeListOf<HTMLDivElement>

    constructor(id: string, delay: number) {
      this.delay = delay;
      this.timeLeft = delay
      this.actualTabIndex = 0;
      this.running = false;
      const container = document.querySelector(`#${id}`)
      if(!container){
        throw new Error(`no DOM element found with the id ${id}`)
      }
      this.container = container as HTMLDivElement
      this.tabsButtons = container.querySelectorAll(".kl-tabs_nav_buttons_button-container")
    }

    private runner(){
      if(!this.running) return
      requestAnimationFrame(()=>{
        this.timeLeft--
        this.percentLeft = Math.floor((100 * this.timeLeft) / this.delay)
        this.updateComponent()
        if(this.timeLeft <= 0){
          this.timeLeft = this.delay
        }
        if(this.running){
          this.runner()
        }
      })
    }

    run() {
      this.running = true
      this.runner()
    }

    stop() {
      this.running = false;
    }

    updateComponent() {
      this.onTimeChangeCb(this.percentLeft)
    }

    onTimeChange(cb:(percent: number) => void){
      this.onTimeChangeCb = cb
    }
    //
    // next() {
    //   if (!this.running) return;
    //   const newIndex = (parseInt(this.actualTabIndex) + 1) % document.querySelectorAll(`#${this.id} .kl-tabs_content > *`).length;
    //   this.changeTab(newIndex);
    //   setTimeout(() => this.next(), this.delay);
    // }
    //
    // prev() {
    //   if (!this.running) return;
    //   const newIndex = (parseInt(this.actualTabIndex) - 1 + document.querySelectorAll(`#${this.id} .kl-tabs_content > *`).length) % document.querySelectorAll(`#${this.id} .kl-tabs_content > *`).length;
    //   this.changeTab(newIndex);
    // }
    //
    // changeTab(index) {
    //   const content = document.querySelectorAll(`#${this.id} .kl-tabs_content > *`);
    //   const buttons = document.querySelectorAll(`#${this.id} .kl-tabs_nav_button`);
    //   content.forEach((el: HTMLDivElement) => {
    //     el.classList.remove("active");
    //   });
    //   content[index]?.classList.add("active");
    //   buttons.forEach((el: HTMLDivElement) => el.classList.remove("active"));
    //   buttons[index]?.classList.add("active");
    //   this.actualTabIndex = index;
    // }
  }
  
  const prueba1 = new KlTabController('perfumes-tabs', 100)
  prueba1.run()
  prueba1.onTimeChange((percent)=>{
    console.log(`desde el callback ${percent}`)
  })

  setTimeout(()=>{
    prueba1.stop()
    console.log("se cierra")
  }, 10000)
</script>
<!--//-->
<!--// document.querySelectorAll('.kl-tabs_container').forEach(container => {-->
<!--  //   const id = container.id;-->
<!--  //   const initialActiveIndex = "0";-->
<!--  //   const tabController = new TabController(id, 3200);-->
<!--  //   tabController.changeTab(initialActiveIndex);-->
<!--  //-->
<!--  //   document.querySelectorAll(`#${id} .kl-tabs_nav_button`).forEach((el: HTMLButtonElement) => {-->
<!--  //     el.addEventListener("click", () => {-->
<!--  //       const {tabIndex} = el.dataset;-->
<!--  //       tabController.changeTab(tabIndex);-->
<!--  //     });-->
<!--  //   });-->
<!--  //-->
<!--  //   const obs = new IntersectionObserver((entries) => {-->
<!--  //     entries.forEach(e => {-->
<!--  //       console.log(e.target.id);-->
<!--  //     });-->
<!--  //   }, {root: null, threshold: 0.0});-->
<!--  //-->
<!--  //   obs.observe(container);-->
<!--  // });-->